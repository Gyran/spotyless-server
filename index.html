<!DOCTYPE html>
<html>
<head>
	<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js'></script>
	<script>
		/* really ugly atm, quickly written just to be able to test */
		var user;

		// number of attempts to reconnect
		var reconnectAttempts;
		var reconnectTimer;

		function resetReconnect() {
			reconnectTimer = -1;
			reconnectAttempts = 0;
		}


		function serverDown() {
			if (reconnectAttempts > 3) {
				console.log("Server probably down!", reconnectAttempts);
				stopApp();
			} else {
				console.log("Reconnected!");
				resetReconnect();
			}
		}


		function init() {
			//$('#userkey').val('e63c4d4a09129a005235c4e6357c67977156994f');

			$('#btnLogin').click(function () {
				login($('#userkey').val());
			});

			$('#btnPlaypause').click(function() {
				var command = {type: 'player', action: 'playpause'};
				$.get("sendSpotifyCommand", {'user': user, 'command': JSON.stringify(command)});
			});

			$('#btnNext').click(function() {
				var command = {type: 'player', action: 'next'};
				$.get("sendSpotifyCommand", {'user': user, 'command': JSON.stringify(command)});
			});

			$('#btnPrevious').click(function() {
				var command = {type: 'player', action: 'previous'};
				$.get("sendSpotifyCommand", {'user': user, 'command': JSON.stringify(command)});
			});

			$('#btnLogin').removeAttr("disabled");
		}

		function login(u) {
			user = u;

			$.post('login', 
				{ user: user},
				function (data) {
					console.log("success", data);
					$('#nowPlaying').text(data.track.data.name);
					login(user);
				},
				'json'
				).error(function(jqXHR, textStatus) {
					++reconnectAttempts;
		  			if (reconnectTimer == -1) {
		  				reconnectTimer = setTimeout(function() { serverDown(); }, 300);
		  			}
		  			waitForCommand();
				});

			$('#login').hide();
			$('#remote').show();
		}

	</script>

	<style type="text/css">

	</style>
</head>
<body onload='init()'>
	<div id='login'>
		<label id='userlabel'>userkey: <input id='userkey' type='text'></label>
		<button id='btnLogin' disabled='true'>Login!</button>
	</div>

	<div id='remote' style='display:none;'>
		<div id='nowPlaying'><!-- --></div>
		<button id='btnPlaypause'>Play/Pause</button>
		<button id='btnNext'>Next track</button>
		<button id='btnPrevious'>Previous track</button>
	</div>
</body>
</html>